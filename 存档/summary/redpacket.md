## redpacket项目总结(未完成)
> redpacket项目是通过商户发红包吸引用户关注自己商品，从而提高自己商品的知名度。有管理、代理、商户、用户四种状态。管理员添加代理。代理管理商户，商户可发红包。

### 管理端：
完成简单的后台CURD，搭建bp，后台功能完成。（没有难度）。添加代理商的时候选择地区只能市级及以上，多次用到了`rtrim`方法进行判定是否是在合法的区域内。

### 代理端：
每一个控制器当中进行查询或者添加删除都需要考虑使用者的权限问题，并且查询只能查询到跟该使用者相关的数据，不能像管理端一样将所有的数据展现出来。

代理端可以发红包，发红包这个过程资金变动是不能让其他有修改的操作参与进来，所以需要开启数据库事务。并且将这个操作锁上，防止数据发生不可逆的错误。

#### 数据库事务
数据库事务(Database Transaction) ，是指作为单个逻辑工作单元执行的一系列操作，要么完全地执行，要么完全地不执行。 事务处理可以确保除非事务性单元内的所有操作都成功完成，否则不会永久更新面向数据的资源。

> 原子性（Atomicity）：事务作为一个整体被执行，包含在其中的对数据库的操作要么全部被执行，要么都不执行。

> 一致性（Consistency）：事务应确保数据库的状态从一个一致状态转变为另一个一致状态。一致状态的含义是数据库中的数据应满足完整性约束。

> 隔离性（Isolation）：多个事务并发执行时，一个事务的执行不应影响其他事务的执行。

> 持久性（Durability）：已被提交的事务对数据库的修改应该永久保存在数据库中。

laravel有简单的方式启用事务
```
DB::transaction(function () {
    //your code
});
```
也可以手动，看选择。

启动事务还不够，我们还需要给资金数据加上一把锁。
#### 悲观锁
悲观锁正如其名，每次取读写数据时候总认为数据会被别人修改，所以将数据加锁，置于锁定状态， 不让别人再访问。缺点是如果持有锁的时间太长，其他用户需要等待很长时间。

#### 乐观锁
执行之前先记下一个版本号，或者修改的时间点。觉得一般情况下不会有太多人修改库存，所以没有加锁，放心地去操作，只有在最后更新的时候才去看是否冲突。 这种方式适合于冲突不多的场景，如果冲突很多，数据争用激烈，会导致不断地尝试，反而降低了性能。

这次选择使用悲观锁。
```Ruby
DB::transaction(function () {
    DB::table('users')->where('votes', '>', 100)->lockForUpdate()->get();
});
```

### 关联关系
管理员想查询一个代理商底下的商户所发的红包，可以使用laravel的远程一对多关系。
```ruby
class Reseller extends Model {
    public function redpackets() {
        return $this->hasManyThrough(Redpacket::class, Merchant::class);
    }
}
```


